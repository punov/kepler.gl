"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.isMSEdge = isMSEdge;
exports.getScaleFromImageSize = getScaleFromImageSize;
exports.calculateExportImageSize = calculateExportImageSize;
exports.convertToPng = convertToPng;
exports.dataURItoBlob = dataURItoBlob;
exports.downloadFile = downloadFile;
exports.exportImage = exportImage;
exports.exportToJsonString = exportToJsonString;
exports.getMapJSON = getMapJSON;
exports.exportJson = exportJson;
exports.exportHtml = exportHtml;
exports.exportData = exportData;
exports.exportMap = exportMap;
exports["default"] = exports.DEFAULT_EXPORT_JSON_SETTINGS = exports.DEFAULT_DATA_NAME = exports.DEFAULT_JSON_NAME = exports.DEFAULT_HTML_NAME = exports.DEFAULT_IMAGE_NAME = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _domToImage = _interopRequireDefault(require("./dom-to-image"));

var _window = require("global/window");

var _defaultSettings = require("../constants/default-settings");

var _exportMapHtml = require("../templates/export-map-html");

var _dataProcessor = require("../processors/data-processor");

var _lodash = _interopRequireDefault(require("lodash.get"));

var _utils = require("./utils");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

/**
 * Default file names
 */
var DEFAULT_IMAGE_NAME = 'kepler-gl.png';
exports.DEFAULT_IMAGE_NAME = DEFAULT_IMAGE_NAME;
var DEFAULT_HTML_NAME = 'kepler.gl.html';
exports.DEFAULT_HTML_NAME = DEFAULT_HTML_NAME;
var DEFAULT_JSON_NAME = 'keplergl.json';
exports.DEFAULT_JSON_NAME = DEFAULT_JSON_NAME;
var DEFAULT_DATA_NAME = 'kepler-gl';
/**
 * Default json export settings
 * @type {{hasData: boolean}}
 */

exports.DEFAULT_DATA_NAME = DEFAULT_DATA_NAME;
var DEFAULT_EXPORT_JSON_SETTINGS = {
  hasData: true
};
exports.DEFAULT_EXPORT_JSON_SETTINGS = DEFAULT_EXPORT_JSON_SETTINGS;

var defaultResolution = _defaultSettings.EXPORT_IMG_RESOLUTION_OPTIONS.find(function (op) {
  return op.id === _defaultSettings.RESOLUTIONS.ONE_X;
});

var defaultRatio = _defaultSettings.EXPORT_IMG_RATIO_OPTIONS.find(function (op) {
  return op.id === _defaultSettings.EXPORT_IMG_RATIOS.FOUR_BY_THREE;
});

function isMSEdge(window) {
  return Boolean(window.navigator && window.navigator.msSaveOrOpenBlob);
}

function getScaleFromImageSize() {
  var imageW = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;
  var imageH = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;
  var mapW = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;
  var mapH = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 0;

  if ([imageW, imageH, mapW, mapH].some(function (d) {
    return d <= 0;
  })) {
    return 1;
  }

  var base = imageW / imageH > 1 ? imageW : imageH;
  var mapBase = imageW / imageH > 1 ? mapW : mapH;
  return base / mapBase;
}

function calculateExportImageSize(_ref) {
  var mapW = _ref.mapW,
      mapH = _ref.mapH,
      ratio = _ref.ratio,
      resolution = _ref.resolution;

  if (mapW <= 0 || mapH <= 0) {
    return null;
  }

  var ratioItem = _defaultSettings.EXPORT_IMG_RATIO_OPTIONS.find(function (op) {
    return op.id === ratio;
  }) || defaultRatio;
  var resolutionItem = _defaultSettings.EXPORT_IMG_RESOLUTION_OPTIONS.find(function (op) {
    return op.id === resolution;
  }) || defaultResolution;

  var _resolutionItem$getSi = resolutionItem.getSize(mapW, mapH),
      scaledWidth = _resolutionItem$getSi.width,
      scaledHeight = _resolutionItem$getSi.height;

  var _ratioItem$getSize = ratioItem.getSize(scaledWidth, scaledHeight),
      imageW = _ratioItem$getSize.width,
      imageH = _ratioItem$getSize.height;

  var _ref2 = ratioItem.id === _defaultSettings.EXPORT_IMG_RATIOS.CUSTOM ? {} : resolutionItem,
      scale = _ref2.scale;

  return {
    scale: scale,
    imageW: imageW,
    imageH: imageH
  };
}

function convertToPng(sourceElem, options) {
  return _domToImage["default"].toPng(sourceElem, options);
}

function dataURItoBlob(dataURI) {
  var binary = (0, _window.atob)(dataURI.split(',')[1]); // separate out the mime component

  var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]; // write the bytes of the string to an ArrayBuffer

  var ab = new _window.ArrayBuffer(binary.length); // create a view into the buffer

  var ia = new _window.Uint8Array(ab);

  for (var i = 0; i < binary.length; i++) {
    ia[i] = binary.charCodeAt(i);
  }

  return new _window.Blob([ab], {
    type: mimeString
  });
}

function downloadFile(fileBlob, fileName) {
  if (isMSEdge(window)) {
    window.navigator.msSaveOrOpenBlob(fileBlob, fileName);
  } else {
    var url = _window.URL.createObjectURL(fileBlob);

    var link = _window.document.createElement('a');

    link.setAttribute('href', url);
    link.setAttribute('download', fileName);

    _window.document.body.appendChild(link);

    link.click();

    _window.document.body.removeChild(link);

    _window.URL.revokeObjectURL(url);
  }
}

function exportImage(state) {
  var imageDataUri = state.uiState.exportImage.imageDataUri;

  if (imageDataUri) {
    var file = dataURItoBlob(imageDataUri);
    downloadFile(file, DEFAULT_IMAGE_NAME);
  }
}

function exportToJsonString(data) {
  try {
    return JSON.stringify(data);
  } catch (e) {
    return e.description;
  }
}

function getMapJSON(state) {
  var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : DEFAULT_EXPORT_JSON_SETTINGS;
  var hasData = options.hasData;
  var schema = state.visState.schema;

  if (!hasData) {
    return schema.getConfigToSave(state);
  }

  var mapToSave = schema.save(state); // add file name if title is not provided

  var title = (0, _lodash["default"])(mapToSave, ['info', 'title']);

  if (!title || !title.length) {
    mapToSave = (0, _utils.set)(['info', 'title'], "keplergl_".concat((0, _utils.generateHashId)(6)), mapToSave);
  }

  return mapToSave;
}

function exportJson(state) {
  var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
  var map = getMapJSON(state, options);
  var fileBlob = new _window.Blob([exportToJsonString(map)], {
    type: 'application/json'
  });
  downloadFile(fileBlob, DEFAULT_JSON_NAME);
}

function exportHtml(state, options) {
  var userMapboxToken = options.userMapboxToken,
      exportMapboxAccessToken = options.exportMapboxAccessToken,
      mode = options.mode;

  var data = _objectSpread(_objectSpread({}, getMapJSON(state)), {}, {
    mapboxApiAccessToken: (userMapboxToken || '') !== '' ? userMapboxToken : exportMapboxAccessToken,
    mode: mode
  });

  var fileBlob = new _window.Blob([(0, _exportMapHtml.exportMapToHTML)(data)], {
    type: 'text/html'
  });
  downloadFile(fileBlob, DEFAULT_HTML_NAME);
}

function exportData(state, option) {
  var visState = state.visState;
  var datasets = visState.datasets;
  var selectedDataset = option.selectedDataset,
      dataType = option.dataType,
      filtered = option.filtered; // get the selected data

  var filename = DEFAULT_DATA_NAME;
  var selectedDatasets = datasets[selectedDataset] ? [datasets[selectedDataset]] : Object.values(datasets);

  if (!selectedDatasets.length) {
    // error: selected dataset not found.
    return;
  }

  selectedDatasets.forEach(function (selectedData) {
    var allData = selectedData.allData,
        fields = selectedData.fields,
        label = selectedData.label,
        _selectedData$filtere = selectedData.filteredIdxCPU,
        filteredIdxCPU = _selectedData$filtere === void 0 ? [] : _selectedData$filtere;
    var toExport = filtered ? filteredIdxCPU.map(function (i) {
      return allData[i];
    }) : allData; // start to export data according to selected data type

    switch (dataType) {
      case _defaultSettings.EXPORT_DATA_TYPE.CSV:
        {
          var csv = (0, _dataProcessor.formatCsv)(toExport, fields);
          var fileBlob = new _window.Blob([csv], {
            type: 'text/csv'
          });
          downloadFile(fileBlob, "".concat(filename, "_").concat(label, ".csv"));
          break;
        }
      // TODO: support more file types.

      default:
        break;
    }
  });
}

function exportMap(state, option) {
  var imageDataUri = state.uiState.exportImage.imageDataUri;
  var thumbnail = imageDataUri ? dataURItoBlob(imageDataUri) : null;
  var mapToSave = getMapJSON(state, option);
  return {
    map: mapToSave,
    thumbnail: thumbnail
  };
}

var exporters = {
  exportImage: exportImage,
  exportJson: exportJson,
  exportHtml: exportHtml,
  exportData: exportData
};
var _default = exporters;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9leHBvcnQtdXRpbHMuanMiXSwibmFtZXMiOlsiREVGQVVMVF9JTUFHRV9OQU1FIiwiREVGQVVMVF9IVE1MX05BTUUiLCJERUZBVUxUX0pTT05fTkFNRSIsIkRFRkFVTFRfREFUQV9OQU1FIiwiREVGQVVMVF9FWFBPUlRfSlNPTl9TRVRUSU5HUyIsImhhc0RhdGEiLCJkZWZhdWx0UmVzb2x1dGlvbiIsIkVYUE9SVF9JTUdfUkVTT0xVVElPTl9PUFRJT05TIiwiZmluZCIsIm9wIiwiaWQiLCJSRVNPTFVUSU9OUyIsIk9ORV9YIiwiZGVmYXVsdFJhdGlvIiwiRVhQT1JUX0lNR19SQVRJT19PUFRJT05TIiwiRVhQT1JUX0lNR19SQVRJT1MiLCJGT1VSX0JZX1RIUkVFIiwiaXNNU0VkZ2UiLCJ3aW5kb3ciLCJCb29sZWFuIiwibmF2aWdhdG9yIiwibXNTYXZlT3JPcGVuQmxvYiIsImdldFNjYWxlRnJvbUltYWdlU2l6ZSIsImltYWdlVyIsImltYWdlSCIsIm1hcFciLCJtYXBIIiwic29tZSIsImQiLCJiYXNlIiwibWFwQmFzZSIsImNhbGN1bGF0ZUV4cG9ydEltYWdlU2l6ZSIsInJhdGlvIiwicmVzb2x1dGlvbiIsInJhdGlvSXRlbSIsInJlc29sdXRpb25JdGVtIiwiZ2V0U2l6ZSIsInNjYWxlZFdpZHRoIiwid2lkdGgiLCJzY2FsZWRIZWlnaHQiLCJoZWlnaHQiLCJDVVNUT00iLCJzY2FsZSIsImNvbnZlcnRUb1BuZyIsInNvdXJjZUVsZW0iLCJvcHRpb25zIiwiZG9tdG9pbWFnZSIsInRvUG5nIiwiZGF0YVVSSXRvQmxvYiIsImRhdGFVUkkiLCJiaW5hcnkiLCJzcGxpdCIsIm1pbWVTdHJpbmciLCJhYiIsIkFycmF5QnVmZmVyIiwibGVuZ3RoIiwiaWEiLCJVaW50OEFycmF5IiwiaSIsImNoYXJDb2RlQXQiLCJCbG9iIiwidHlwZSIsImRvd25sb2FkRmlsZSIsImZpbGVCbG9iIiwiZmlsZU5hbWUiLCJ1cmwiLCJVUkwiLCJjcmVhdGVPYmplY3RVUkwiLCJsaW5rIiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50Iiwic2V0QXR0cmlidXRlIiwiYm9keSIsImFwcGVuZENoaWxkIiwiY2xpY2siLCJyZW1vdmVDaGlsZCIsInJldm9rZU9iamVjdFVSTCIsImV4cG9ydEltYWdlIiwic3RhdGUiLCJpbWFnZURhdGFVcmkiLCJ1aVN0YXRlIiwiZmlsZSIsImV4cG9ydFRvSnNvblN0cmluZyIsImRhdGEiLCJKU09OIiwic3RyaW5naWZ5IiwiZSIsImRlc2NyaXB0aW9uIiwiZ2V0TWFwSlNPTiIsInNjaGVtYSIsInZpc1N0YXRlIiwiZ2V0Q29uZmlnVG9TYXZlIiwibWFwVG9TYXZlIiwic2F2ZSIsInRpdGxlIiwiZXhwb3J0SnNvbiIsIm1hcCIsImV4cG9ydEh0bWwiLCJ1c2VyTWFwYm94VG9rZW4iLCJleHBvcnRNYXBib3hBY2Nlc3NUb2tlbiIsIm1vZGUiLCJtYXBib3hBcGlBY2Nlc3NUb2tlbiIsImV4cG9ydERhdGEiLCJvcHRpb24iLCJkYXRhc2V0cyIsInNlbGVjdGVkRGF0YXNldCIsImRhdGFUeXBlIiwiZmlsdGVyZWQiLCJmaWxlbmFtZSIsInNlbGVjdGVkRGF0YXNldHMiLCJPYmplY3QiLCJ2YWx1ZXMiLCJmb3JFYWNoIiwic2VsZWN0ZWREYXRhIiwiYWxsRGF0YSIsImZpZWxkcyIsImxhYmVsIiwiZmlsdGVyZWRJZHhDUFUiLCJ0b0V4cG9ydCIsIkVYUE9SVF9EQVRBX1RZUEUiLCJDU1YiLCJjc3YiLCJleHBvcnRNYXAiLCJ0aHVtYm5haWwiLCJleHBvcnRlcnMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXFCQTs7QUFDQTs7QUFDQTs7QUFPQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7O0FBRUE7QUFDQTtBQUNBO0FBQ08sSUFBTUEsa0JBQWtCLEdBQUcsZUFBM0I7O0FBQ0EsSUFBTUMsaUJBQWlCLEdBQUcsZ0JBQTFCOztBQUNBLElBQU1DLGlCQUFpQixHQUFHLGVBQTFCOztBQUNBLElBQU1DLGlCQUFp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O0FBQ0EsTUFBTWEsU0FBUyxHQUFHSixVQUFVLENBQUNWLEtBQUQsRUFBUXlCLE1BQVIsQ0FBNUI7QUFFQSxTQUFPO0FBQ0xQLElBQUFBLEdBQUcsRUFBRUosU0FEQTtBQUVMK0IsSUFBQUEsU0FBUyxFQUFUQTtBQUZLLEdBQVA7QUFJRDs7QUFFRCxJQUFNQyxTQUFTLEdBQUc7QUFDaEIvQyxFQUFBQSxXQUFXLEVBQVhBLFdBRGdCO0FBRWhCa0IsRUFBQUEsVUFBVSxFQUFWQSxVQUZnQjtBQUdoQkUsRUFBQUEsVUFBVSxFQUFWQSxVQUhnQjtBQUloQkssRUFBQUEsVUFBVSxFQUFWQTtBQUpnQixDQUFsQjtlQU9lc0IsUyIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgMjAyMSBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5cbi8vIEB0cy1ub2NoZWNrXG5pbXBvcnQgZG9tdG9pbWFnZSBmcm9tICd1dGlscy9kb20tdG8taW1hZ2UnO1xuaW1wb3J0IHtCbG9iLCBVUkwsIGF0b2IsIFVpbnQ4QXJyYXksIEFycmF5QnVmZmVyLCBkb2N1bWVudH0gZnJvbSAnZ2xvYmFsL3dpbmRvdyc7XG5pbXBvcnQge1xuICBFWFBPUlRfSU1HX1JFU09MVVRJT05fT1BUSU9OUyxcbiAgRVhQT1JUX0lNR19SQVRJT19PUFRJT05TLFxuICBSRVNPTFVUSU9OUyxcbiAgRVhQT1JUX0lNR19SQVRJT1MsXG4gIEVYUE9SVF9EQVRBX1RZUEVcbn0gZnJvbSAnY29uc3RhbnRzL2RlZmF1bHQtc2V0dGluZ3MnO1xuaW1wb3J0IHtleHBvcnRNYXBUb0hUTUx9IGZyb20gJ3RlbXBsYXRlcy9leHBvcnQtbWFwLWh0bWwnO1xuaW1wb3J0IHtmb3JtYXRDc3Z9IGZyb20gJ3Byb2Nlc3NvcnMvZGF0YS1wcm9jZXNzb3InO1xuaW1wb3J0IGdldCBmcm9tICdsb2Rhc2guZ2V0JztcbmltcG9ydCB7c2V0LCBnZW5lcmF0ZUhhc2hJZH0gZnJvbSAndXRpbHMvdXRpbHMnO1xuXG4vKipcbiAqIERlZmF1bHQgZmlsZSBuYW1lc1xuICovXG5leHBvcnQgY29uc3QgREVGQVVMVF9JTUFHRV9OQU1FID0gJ2tlcGxlci1nbC5wbmcnO1xuZXhwb3J0IGNvbnN0IERFRkFVTFRfSFRNTF9OQU1FID0gJ2tlcGxlci5nbC5odG1sJztcbmV4cG9ydCBjb25zdCBERUZBVUxUX0pTT05fTkFNRSA9ICdrZXBsZXJnbC5qc29uJztcbmV4cG9ydCBjb25zdCBERUZBVUxUX0RBVEFfTkFNRSA9ICdrZXBsZXItZ2wnO1xuXG4vKipcbiAqIERlZmF1bHQganNvbiBleHBvcnQgc2V0dGluZ3NcbiAqIEB0eXBlIHt7aGFzRGF0YTogYm9vbGVhbn19XG4gKi9cbmV4cG9ydCBjb25zdCBERUZBVUxUX0VYUE9SVF9KU09OX1NFVFRJTkdTID0ge1xuICBoYXNEYXRhOiB0cnVlXG59O1xuXG5jb25zdCBkZWZhdWx0UmVzb2x1dGlvbiA9IEVYUE9SVF9JTUdfUkVTT0xVVElPTl9PUFRJT05TLmZpbmQob3AgPT4gb3AuaWQgPT09IFJFU09MVVRJT05TLk9ORV9YKTtcblxuY29uc3QgZGVmYXVsdFJhdGlvID0gRVhQT1JUX0lNR19SQVRJT19PUFRJT05TLmZpbmQob3AgPT4gb3AuaWQgPT09IEVYUE9SVF9JTUdfUkFUSU9TLkZPVVJfQllfVEhSRUUpO1xuXG5leHBvcnQgZnVuY3Rpb24gaXNNU0VkZ2Uod2luZG93KSB7XG4gIHJldHVybiBCb29sZWFuKHdpbmRvdy5uYXZpZ2F0b3IgJiYgd2luZG93Lm5hdmlnYXRvci5tc1NhdmVPck9wZW5CbG9iKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFNjYWxlRnJvbUltYWdlU2l6ZShpbWFnZVcgPSAwLCBpbWFnZUggPSAwLCBtYXBXID0gMCwgbWFwSCA9IDApIHtcbiAgaWYgKFtpbWFnZVcsIGltYWdlSCwgbWFwVywgbWFwSF0uc29tZShkID0+IGQgPD0gMCkpIHtcbiAgICByZXR1cm4gMTtcbiAgfVxuXG4gIGNvbnN0IGJhc2UgPSBpbWFnZVcgLyBpbWFnZUggPiAxID8gaW1hZ2VXIDogaW1hZ2VIO1xuICBjb25zdCBtYXBCYXNlID0gaW1hZ2VXIC8gaW1hZ2VIID4gMSA/IG1hcFcgOiBtYXBIO1xuICByZXR1cm4gYmFzZSAvIG1hcEJhc2U7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVFeHBvcnRJbWFnZVNpemUoe21hcFcsIG1hcEgsIHJhdGlvLCByZXNvbHV0aW9ufSkge1xuICBpZiAobWFwVyA8PSAwIHx8IG1hcEggPD0gMCkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgY29uc3QgcmF0aW9JdGVtID0gRVhQT1JUX0lNR19SQVRJT19PUFRJT05TLmZpbmQob3AgPT4gb3AuaWQgPT09IHJhdGlvKSB8fCBkZWZhdWx0UmF0aW87XG5cbiAgY29uc3QgcmVzb2x1dGlvbkl0ZW0gPVxuICAgIEVYUE9SVF9JTUdfUkVTT0xVVElPTl9PUFRJT05TLmZpbmQob3AgPT4gb3AuaWQgPT09IHJlc29sdXRpb24pIHx8IGRlZmF1bHRSZXNvbHV0aW9uO1xuXG4gIGNvbnN0IHt3aWR0aDogc2NhbGVkV2lkdGgsIGhlaWdodDogc2NhbGVkSGVpZ2h0fSA9IHJlc29sdXRpb25JdGVtLmdldFNpemUobWFwVywgbWFwSCk7XG5cbiAgY29uc3Qge3dpZHRoOiBpbWFnZVcsIGhlaWdodDogaW1hZ2VIfSA9IHJhdGlvSXRlbS5nZXRTaXplKHNjYWxlZFdpZHRoLCBzY2FsZWRIZWlnaHQpO1xuXG4gIGNvbnN0IHtzY2FsZX0gPSByYXRpb0l0ZW0uaWQgPT09IEVYUE9SVF9JTUdfUkFUSU9TLkNVU1RPTSA/IHt9IDogcmVzb2x1dGlvbkl0ZW07XG5cbiAgcmV0dXJuIHtcbiAgICBzY2FsZSxcbiAgICBpbWFnZVcsXG4gICAgaW1hZ2VIXG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb252ZXJ0VG9Qbmcoc291cmNlRWxlbSwgb3B0aW9ucykge1xuICByZXR1cm4gZG9tdG9pbWFnZS50b1BuZyhzb3VyY2VFbGVtLCBvcHRpb25zKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRhdGFVUkl0b0Jsb2IoZGF0YVVSSSkge1xuICBjb25zdCBiaW5hcnkgPSBhdG9iKGRhdGFVUkkuc3BsaXQoJywnKVsxXSk7XG5cbiAgLy8gc2VwYXJhdGUgb3V0IHRoZSBtaW1lIGNvbXBvbmVudFxuICBjb25zdCBtaW1lU3RyaW5nID0gZGF0YVVSSVxuICAgIC5zcGxpdCgnLCcpWzBdXG4gICAgLnNwbGl0KCc6JylbMV1cbiAgICAuc3BsaXQoJzsnKVswXTtcblxuICAvLyB3cml0ZSB0aGUgYnl0ZXMgb2YgdGhlIHN0cmluZyB0byBhbiBBcnJheUJ1ZmZlclxuICBjb25zdCBhYiA9IG5ldyBBcnJheUJ1ZmZlcihiaW5hcnkubGVuZ3RoKTtcblxuICAvLyBjcmVhdGUgYSB2aWV3IGludG8gdGhlIGJ1ZmZlclxuICBjb25zdCBpYSA9IG5ldyBVaW50OEFycmF5KGFiKTtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGJpbmFyeS5sZW5ndGg7IGkrKykge1xuICAgIGlhW2ldID0gYmluYXJ5LmNoYXJDb2RlQXQoaSk7XG4gIH1cblxuICByZXR1cm4gbmV3IEJsb2IoW2FiXSwge3R5cGU6IG1pbWVTdHJpbmd9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRvd25sb2FkRmlsZShmaWxlQmxvYiwgZmlsZU5hbWUpIHtcbiAgaWYgKGlzTVNFZGdlKHdpbmRvdykpIHtcbiAgICB3aW5kb3cubmF2aWdhdG9yLm1zU2F2ZU9yT3BlbkJsb2IoZmlsZUJsb2IsIGZpbGVOYW1lKTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGZpbGVCbG9iKTtcblxuICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7XG4gICAgbGluay5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCB1cmwpO1xuICAgIGxpbmsuc2V0QXR0cmlidXRlKCdkb3dubG9hZCcsIGZpbGVOYW1lKTtcblxuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobGluayk7XG4gICAgbGluay5jbGljaygpO1xuICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQobGluayk7XG4gICAgVVJMLnJldm9rZU9iamVjdFVSTCh1cmwpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBleHBvcnRJbWFnZShzdGF0ZSkge1xuICBjb25zdCB7aW1hZ2VEYXRhVXJpfSA9IHN0YXRlLnVpU3RhdGUuZXhwb3J0SW1hZ2U7XG4gIGlmIChpbWFnZURhdGFVcmkpIHtcbiAgICBjb25zdCBmaWxlID0gZGF0YVVSSXRvQmxvYihpbWFnZURhdGFVcmkpO1xuICAgIGRvd25sb2FkRmlsZShmaWxlLCBERUZBVUxUX0lNQUdFX05BTUUpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBleHBvcnRUb0pzb25TdHJpbmcoZGF0YSkge1xuICB0cnkge1xuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShkYXRhKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHJldHVybiBlLmRlc2NyaXB0aW9uO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRNYXBKU09OKHN0YXRlLCBvcHRpb25zID0gREVGQVVMVF9FWFBPUlRfSlNPTl9TRVRUSU5HUykge1xuICBjb25zdCB7aGFzRGF0YX0gPSBvcHRpb25zO1xuICBjb25zdCBzY2hlbWEgPSBzdGF0ZS52aXNTdGF0ZS5zY2hlbWE7XG5cbiAgaWYgKCFoYXNEYXRhKSB7XG4gICAgcmV0dXJuIHNjaGVtYS5nZXRDb25maWdUb1NhdmUoc3RhdGUpO1xuICB9XG5cbiAgbGV0IG1hcFRvU2F2ZSA9IHNjaGVtYS5zYXZlKHN0YXRlKTtcbiAgLy8gYWRkIGZpbGUgbmFtZSBpZiB0aXRsZSBpcyBub3QgcHJvdmlkZWRcbiAgY29uc3QgdGl0bGUgPSBnZXQobWFwVG9TYXZlLCBbJ2luZm8nLCAndGl0bGUnXSk7XG4gIGlmICghdGl0bGUgfHwgIXRpdGxlLmxlbmd0aCkge1xuICAgIG1hcFRvU2F2ZSA9IHNldChbJ2luZm8nLCAndGl0bGUnXSwgYGtlcGxlcmdsXyR7Z2VuZXJhdGVIYXNoSWQoNil9YCwgbWFwVG9TYXZlKTtcbiAgfVxuICByZXR1cm4gbWFwVG9TYXZlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZXhwb3J0SnNvbihzdGF0ZSwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IG1hcCA9IGdldE1hcEpTT04oc3RhdGUsIG9wdGlvbnMpO1xuXG4gIGNvbnN0IGZpbGVCbG9iID0gbmV3IEJsb2IoW2V4cG9ydFRvSnNvblN0cmluZyhtYXApXSwge3R5cGU6ICdhcHBsaWNhdGlvbi9qc29uJ30pO1xuICBkb3dubG9hZEZpbGUoZmlsZUJsb2IsIERFRkFVTFRfSlNPTl9OQU1FKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGV4cG9ydEh0bWwoc3RhdGUsIG9wdGlvbnMpIHtcbiAgY29uc3Qge3VzZXJNYXBib3hUb2tlbiwgZXhwb3J0TWFwYm94QWNjZXNzVG9rZW4sIG1vZGV9ID0gb3B0aW9ucztcblxuICBjb25zdCBkYXRhID0ge1xuICAgIC4uLmdldE1hcEpTT04oc3RhdGUpLFxuICAgIG1hcGJveEFwaUFjY2Vzc1Rva2VuOlxuICAgICAgKHVzZXJNYXBib3hUb2tlbiB8fCAnJykgIT09ICcnID8gdXNlck1hcGJveFRva2VuIDogZXhwb3J0TWFwYm94QWNjZXNzVG9rZW4sXG4gICAgbW9kZVxuICB9O1xuXG4gIGNvbnN0IGZpbGVCbG9iID0gbmV3IEJsb2IoW2V4cG9ydE1hcFRvSFRNTChkYXRhKV0sIHt0eXBlOiAndGV4dC9odG1sJ30pO1xuICBkb3dubG9hZEZpbGUoZmlsZUJsb2IsIERFRkFVTFRfSFRNTF9OQU1FKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGV4cG9ydERhdGEoc3RhdGUsIG9wdGlvbikge1xuICBjb25zdCB7dmlzU3RhdGV9ID0gc3RhdGU7XG4gIGNvbnN0IHtkYXRhc2V0c30gPSB2aXNTdGF0ZTtcbiAgY29uc3Qge3NlbGVjdGVkRGF0YXNldCwgZGF0YVR5cGUsIGZpbHRlcmVkfSA9IG9wdGlvbjtcbiAgLy8gZ2V0IHRoZSBzZWxlY3RlZCBkYXRhXG4gIGNvbnN0IGZpbGVuYW1lID0gREVGQVVMVF9EQVRBX05BTUU7XG4gIGNvbnN0IHNlbGVjdGVkRGF0YXNldHMgPSBkYXRhc2V0c1tzZWxlY3RlZERhdGFzZXRdXG4gICAgPyBbZGF0YXNldHNbc2VsZWN0ZWREYXRhc2V0XV1cbiAgICA6IE9iamVjdC52YWx1ZXMoZGF0YXNldHMpO1xuICBpZiAoIXNlbGVjdGVkRGF0YXNldHMubGVuZ3RoKSB7XG4gICAgLy8gZXJyb3I6IHNlbGVjdGVkIGRhdGFzZXQgbm90IGZvdW5kLlxuICAgIHJldHVybjtcbiAgfVxuXG4gIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChzZWxlY3RlZERhdGEgPT4ge1xuICAgIGNvbnN0IHthbGxEYXRhLCBmaWVsZHMsIGxhYmVsLCBmaWx0ZXJlZElkeENQVSA9IFtdfSA9IHNlbGVjdGVkRGF0YTtcbiAgICBjb25zdCB0b0V4cG9ydCA9IGZpbHRlcmVkID8gZmlsdGVyZWRJZHhDUFUubWFwKGkgPT4gYWxsRGF0YVtpXSkgOiBhbGxEYXRhO1xuICAgIC8vIHN0YXJ0IHRvIGV4cG9ydCBkYXRhIGFjY29yZGluZyB0byBzZWxlY3RlZCBkYXRhIHR5cGVcbiAgICBzd2l0Y2ggKGRhdGFUeXBlKSB7XG4gICAgICBjYXNlIEVYUE9SVF9EQVRBX1RZUEUuQ1NWOiB7XG4gICAgICAgIGNvbnN0IGNzdiA9IGZvcm1hdENzdih0b0V4cG9ydCwgZmllbGRzKTtcblxuICAgICAgICBjb25zdCBmaWxlQmxvYiA9IG5ldyBCbG9iKFtjc3ZdLCB7dHlwZTogJ3RleHQvY3N2J30pO1xuICAgICAgICBkb3dubG9hZEZpbGUoZmlsZUJsb2IsIGAke2ZpbGVuYW1lfV8ke2xhYmVsfS5jc3ZgKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICAvLyBUT0RPOiBzdXBwb3J0IG1vcmUgZmlsZSB0eXBlcy5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBleHBvcnRNYXAoc3RhdGUsIG9wdGlvbikge1xuICBjb25zdCB7aW1hZ2VEYXRhVXJpfSA9IHN0YXRlLnVpU3RhdGUuZXhwb3J0SW1hZ2U7XG4gIGNvbnN0IHRodW1ibmFpbCA9IGltYWdlRGF0YVVyaSA/IGRhdGFVUkl0b0Jsb2IoaW1hZ2VEYXRhVXJpKSA6IG51bGw7XG4gIGNvbnN0IG1hcFRvU2F2ZSA9IGdldE1hcEpTT04oc3RhdGUsIG9wdGlvbik7XG5cbiAgcmV0dXJuIHtcbiAgICBtYXA6IG1hcFRvU2F2ZSxcbiAgICB0aHVtYm5haWxcbiAgfTtcbn1cblxuY29uc3QgZXhwb3J0ZXJzID0ge1xuICBleHBvcnRJbWFnZSxcbiAgZXhwb3J0SnNvbixcbiAgZXhwb3J0SHRtbCxcbiAgZXhwb3J0RGF0YVxufTtcblxuZXhwb3J0IGRlZmF1bHQgZXhwb3J0ZXJzO1xuIl19